{% extends 'layout.html' %}

{% block content %}
<header class="primary-header">
    <h1>Geiger</h1>
    <input type="text" class="url" placeholder="(ﾉ◕ヮ◕)ﾉ*:･ﾟ✧ Enter a url to a NYT article w/ comments" />
</header>

<div class="tabbed">
    <ul class="tabs">
        <li class="active" data-tab="subject"><h1>Subject</h1></li>
        <li data-tab="talked-about"><h1>Talked About</h1></li>
        <li data-tab="geiger"><h1>Geiger</h1></li>
        <li data-tab="baseline"><h1>Baseline</h1></li>
    </ul>
    <div class="subject active">
        <div class="loading hide">
            <div class="loader"></div>
            <h4>Loading article...</h4>
        </div>
        <div class="error hide"></div>
        <h1 class="subject--title"></h1>
        <div class="subject--body"></div>
    </div>
    <div class="talked-about hide">
        <div class="loading hide">
            <div class="loader"></div>
            <h4>Loading "talked about"...</h4>
        </div>
        <div class="error hide"></div>
        <ul class="thread"></ul>
    </div>
    <div class="geiger hide">
        <div class="loading hide">
            <div class="loader"></div>
            <h4>Loading Geiger results...</h4>
        </div>
        <div class="error hide"></div>
        <div class="top-terms hide">
            <h5>Most salient terms</h5>
            <ul class="terms"></ul>
        </div>
        <ul class="thread"></ul>
    </div>
    <div class="baseline hide">
        <div class="loading hide">
            <div class="loader"></div>
            <h4>Loading baseline results...</h4>
        </div>
        <div class="error hide"></div>
        <ul class="thread"></ul>
    </div>
</div>


<script type="text/html" id="highlight_tmpl">
    <li class="comment">
        <span class="quote">“</span><span class="ellipsis">... </span>{0}<span class="ellipsis"> ...</span><span class="quote">”</span>
        <h6 class="support"><a href="#" class="author"><span>{1}</span></a> and <a href="#" class="commenters"><span>{2}</span> other commenters</a></h6>
        <div class="full-comment hide">{3}</div>
        <ul class="cohort hide">{4}</ul>
    </li>
</script>

<script type="text/html" id="cluster_tmpl">
    <li class="comment">
        <ul class="cluster-terms terms">{0}</ul>
        <h6 class="support"><a href="#" class="commenters"><span>{2}</span> comments</a></h6>
        <ul class="cohort hide">{1}</ul>
    </li>
</script>

<script type="text/html" id="baseline_tmpl">
    <li class="comment">
        <p>{0}</p>
        <h6 class="support"><a href="#" class="commenters"><span>{2}</span> comments</a></h6>
        <ul class="cohort hide">{1}</ul>
    </li>
</script>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="/js/main.js"></script>
<script type="text/javascript">
    $(function() {
        var comments;

        // Submit an NYT article url to load.
        // This only works on the NYT internal network :(
        $('input.url').on('keypress', function(ev) {
            // Enter
            if (ev.keyCode == 13) {
                var url = $(this).val();

                // Remove URL params, they can mess up the fetching of comments.
                url = url.split('?')[0]
                $(this).val(url);

                $('.subject--title, .subject--body').empty();

                get_comments(url);
                $('[data-tab=subject]').click();
            }
        });

        // Show full comments on mouseenter of author name.
        $('body').on('mouseenter', '.author', function() {
            var parent = $(this).closest('.comment');
            parent.find('.cohort').hide();
            parent.find('.full-comment').show();
        });

        // Show cohort on mouseenter of support.
        $('body').on('mouseenter', '.commenters', function() {
            var parent = $(this).closest('.comment');
            parent.find('.full-comment').hide();
            parent.find('.cohort').show();
        });

        $('body').on('mouseleave', '.comment', function() {
            $(this).find('.full-comment, .cohort').hide();
        });

        // oof
        $('body').on('mouseenter', '.geiger .comment .cohort .terms li', function() {
            var term = $(this).data('term');
            $(this).closest('.cohort').addClass('subdued');
            $(this).closest('.cohort').find('.highlight[data-term="'+term+'"]').addClass('highlight-active');
        });
        $('body').on('mouseleave', '.geiger .comment .cohort .terms li', function() {
            $('.highlight-active').removeClass('highlight-active');
            $('.subdued').removeClass('subdued');
        });

        // IDF tooltips
        $('body').on('mouseenter', '.term', function() {
            var gidf = $(this).data('gidf'),
                lidf = $(this).data('lidf'),
                salience = $(this).data('salience');

            $(this).append('<div class="idf-tooltip">Global idf: '+gidf.toFixed(3)+'<br />Local idf: '+lidf.toFixed(3)+'<br />Salience: '+salience.toFixed(3)+'</div>');
        });
        $('body').on('mouseleave', '.term', function() {
            $(this).find('.idf-tooltip').remove();
        });

        $('.tabs li').on('click', function() {
            var tab = $(this).data('tab');
            $('.tabs .active').removeClass('active');
            $('.active').addClass('hide').removeClass('active');
            $(this).addClass('active');
            $('.'+tab).removeClass('hide').addClass('active');
        });


        // Load data for an NYT url.
        function get_comments(url) {
            $('.subject .error').hide();
            $('.subject .loading').show();
            $.ajax('/api/comments', {
                method: 'GET',
                accepts: 'application/json',
                data: {
                    url: url
                },
                error: function(xhr, status, err) {
                    $('.subject .error').text(err).show();
                },
                success: function(data, status, xhr) {
                    comments = data.comments;
                    $('.subject--title').text(data.title);
                    $('.subject--body').html(data.body);

                    // Load "talked about", "baseline", and "geigerized" right after
                    get_talked_about();
                    get_baseline();
                    get_geigerized();
                },
                complete: function() {
                    $('.subject .loading').hide();
                }
            });
        }

        // Get Geiger results
        function get_geigerized() {
            var el = $('.geiger'),
                thread = el.find('.thread'),
                terms = el.find('.terms'),
                top_terms = el.find('.top-terms');

            el.find('.loading').show();
            $('.tabs li[data-tab=geiger]')
                .addClass('loading').removeClass('error');
            thread.empty();
            terms.empty();
            top_terms.hide();

            $.ajax('/api/geiger', {
                method: 'POST',
                accepts: 'application/json',
                contentType: 'application/json',
                dataType: 'json',
                data: JSON.stringify({
                    comments: comments,
                }),
                error: function(xhr, status, err) {
                    el.find('.error').text(err).show();
                    $('.tabs li[data-tab=geiger]').addClass('error');
                },
                success: function(data, status, xhr) {
                    var data = data.results;

                    for (var i=0; i < data.clusters.length; i++) {
                        var clus = data.clusters[i][0],
                            desc = data.clusters[i][1],
                            clus_html = '',
                            desc_html = '',
                            hel;

                        // List the top 10 terms describing this cluster
                        var n_terms = desc.length > 10 ? 10 : desc.length;
                        for (var j=0; j < n_terms; j++) {
                            var term = desc[j][0],
                                freq = desc[j][1],
                                nsal = desc[j][2];
                            desc_html += '<li style="background-color:' + color_for_percent(nsal) +
                                         ';" class="term" data-gidf="' + data.gidf[term] + '" data-lidf="' + data.lidf[term] + '" data-salience="' + data.saliences[term] + '">' +
                                         term + '</li>';
                        }

                        // List out the other comments in this cluster with their terms
                        for (var j=0; j < clus.length; j++) {
                            var term_html = '';
                                com_terms = clus[j][3];
                            for (var k=0; k < com_terms.length; k++) {
                                var term = com_terms[k][0],
                                    freq = com_terms[k][1];
                                    nsal = com_terms[k][2];
                                term_html += '<li data-term="'+ term +'" style="background-color:'+ color_for_percent(nsal) +
                                    ';" class="term" data-gidf="' + data.gidf[term] + '" data-lidf="' + data.lidf[term] + '" data-salience="' + data.saliences[term] + '">' +
                                    term + ' x' + freq.toString() + '</li>';
                            }
                            clus_html += '<li>' + clus[j][2] + '<ul class="terms">' + term_html + '</ul></li>';
                        }

                        // Build the HTML.
                        hel = $('#cluster_tmpl')
                                .html()
                                .format(desc_html, clus_html, clus.length);

                        thread.append(hel);
                    }

                    // Render top salient terms
                    for (var i=0; i < 20; i++) {
                        var term = data.terms[i][0];
                        terms.append('<li style="background-color:'+ color_for_percent(data.terms[i][1]) +
                                ';" class="term" data-gidf="' + data.gidf[term] + '" data-lidf="' + data.lidf[term] + '" data-salience="' + data.saliences[term] + '">' +
                                term+'</li>');
                    }

                    top_terms.removeClass('hide').show();
                },
                complete: function() {
                    el.find('.loading').hide();
                    $('.tabs li[data-tab=geiger]').removeClass('loading');
                }
            });
        }

        function get_talked_about() {
            var el = $('.talked-about'),
                thread = el.find('.thread');

            el.find('.loading').show();
            $('.tabs li[data-tab=talked-about]')
                .addClass('loading').removeClass('error');
            thread.empty();

            $.ajax('/api/talked-about', {
                method: 'POST',
                accepts: 'application/json',
                contentType: 'application/json',
                dataType: 'json',
                data: JSON.stringify({
                    comments: comments
                }),
                error: function(xhr, status, err) {
                    el.find('.error').text(err).show();
                    $('.tabs li[data-tab=talked-about]').addClass('error');
                },
                success: function(data, status, xhr) {
                    var data = data.results;
                    for (var i=0; i < data.length; i++) {
                        var res = data[i],
                            coh = '',
                            hel;

                        // List out the other sentences in this cohort.
                        for (var j=0; j < res.cohort.length; j++) {
                            coh += '<li>' + res.cohort[j] + '</li>';
                        }

                        // Build the highlight HTML.
                        hel = $('#highlight_tmpl')
                                .html()
                                .format(res.sentence, res.comment.author, res.support, res.comment.body, coh);

                        thread.append('<h5>{0}</h5>{1}'.format(res.aspect, hel));
                    }
                },
                complete: function() {
                    el.find('.loading').hide();
                    $('.tabs li[data-tab=talked-about]').removeClass('loading');
                }
            });

        }

        function get_baseline() {
            var el = $('.baseline'),
                thread = el.find('.thread');

            el.find('.loading').show();
            $('.tabs li[data-tab=baseline]')
                .addClass('loading').removeClass('error');
            thread.empty();

            $.ajax('/api/baseline', {
                method: 'POST',
                accepts: 'application/json',
                contentType: 'application/json',
                dataType: 'json',
                data: JSON.stringify({
                    comments: comments
                }),
                error: function(xhr, status, err) {
                    el.find('.error').text(err).show();
                    $('.tabs li[data-tab=baseline]').addClass('error');
                },
                success: function(data, status, xhr) {
                    var data = data.results;
                    for (var i=0; i < data.length; i++) {
                        var clus = data[i],
                            coh = '',
                            hel;

                        // List out the other sentences in this cohort.
                        for (var j=1; j < clus.length; j++) {
                            coh += '<li>' + clus[j] + '</li>';
                        }

                        // Build the HTML.
                        hel = $('#baseline_tmpl')
                                .html()
                                .format(clus[0], coh, clus.length);

                        thread.append('{0}'.format(hel));
                    }
                },
                complete: function() {
                    el.find('.loading').hide();
                    $('.tabs li[data-tab=baseline]').removeClass('loading');
                }
            });

        }



        // Credit: <https://stackoverflow.com/a/7128796>
        var percent_colors = [
            { pct: 0.0, color: { r: 0x31, g: 0x70, b: 0x8F } },
            { pct: 1.0, color: { r: 0x0A, g: 0xCA, b: 0x5C } } ];

        var color_for_percent = function(pct) {
            for (var i = 1; i < percent_colors.length - 1; i++) {
                if (pct < percent_colors[i].pct) {
                    break;
                }
            }
            var lower = percent_colors[i - 1];
            var upper = percent_colors[i];
            var range = upper.pct - lower.pct;
            var rangePct = (pct - lower.pct) / range;
            var pctLower = 1 - rangePct;
            var pctUpper = rangePct;
            var color = {
                r: Math.floor(lower.color.r * pctLower + upper.color.r * pctUpper),
                g: Math.floor(lower.color.g * pctLower + upper.color.g * pctUpper),
                b: Math.floor(lower.color.b * pctLower + upper.color.b * pctUpper)
            };
            return 'rgb(' + [color.r, color.g, color.b].join(',') + ')';
        }
    });
</script>

{% endblock %}
