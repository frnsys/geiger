{% extends 'layout.html' %}

{% block content %}
<header class="primary-header">
    <h1>Geiger</h1>
    <input type="text" class="url" placeholder="(ﾉ◕ヮ◕)ﾉ*:･ﾟ✧ Enter a url to a NYT article w/ comments" />
</header>

<div class="tabbed">
    <ul class="tabs">
        <li class="active" data-tab="subject"><h1>Subject</h1></li>
        <li data-tab="talked-about"><h1>Talked About</h1></li>
        <li data-tab="geiger"><h1>Geiger</h1></li>
    </ul>
    <div class="subject active">
        <div class="loading">
            <div class="loader"></div>
            <h4>Loading article...</h4>
        </div>
        <div class="error hide"></div>
        <h1 class="subject--title"></h1>
        <div class="subject--body"></div>
    </div>
    <div class="talked-about hide">
        <div class="loading">
            <div class="loader"></div>
            <h4>Loading "talked about"...</h4>
        </div>
        <div class="error hide"></div>
        <ul class="thread"></ul>
    </div>
    <div class="geiger hide">
        <div class="loading">
            <div class="loader"></div>
            <h4>Loading Geiger results...</h4>
        </div>
        <div class="error hide"></div>
        <ul class="thread"></ul>
        <ul class="terms"></ul>
    </div>
</div>


<script type="text/html" id="highlight_tmpl">
    <li class="comment">
        <span class="quote">“</span><span class="ellipsis">... </span>{0}<span class="ellipsis"> ...</span><span class="quote">”</span>
        <h6 class="support"><a href="#" class="author"><span>{1}</span></a> and <a href="#" class="commenters"><span>{2}</span> other commenters</a></h6>
        <div class="full-comment hide">{3}</div>
        <ul class="cohort hide">{4}</ul>
    </li>
</script>

<script type="text/html" id="cluster_tmpl">
    <li class="comment">
        <ul class="cluster_terms">{0}</ul>
        <h6 class="support"><a href="#" class="commenters"><span>{2}</span> comments</a></h6>
        <ul class="cohort hide">{1}</ul>
    </li>
</script>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="/js/main.js"></script>
<script type="text/javascript">
    $(function() {
        var comments;

        // By default, just load example data.
        get_comments($('input.url').val());

        // Submit an NYT article url to load.
        // This only works on the NYT internal network :(
        $('input.url').on('keypress', function(ev) {
            // Enter
            if (ev.keyCode == 13) {
                var url = $(this).val();

                // Remove URL params, they can mess up the fetching of comments.
                url = url.split('?')[0]
                $(this).val(url);

                $('.subject--title, .subject--body').empty();

                get_comments(url);
            }
        });

        // Show full comments on mouseenter of author name.
        $('body').on('mouseenter', '.author', function() {
            var parent = $(this).closest('.comment');
            parent.find('.cohort').hide();
            parent.find('.full-comment').show();
        });

        // Show cohort on mouseenter of support.
        $('body').on('mouseenter', '.commenters', function() {
            var parent = $(this).closest('.comment');
            parent.find('.full-comment').hide();
            parent.find('.cohort').show();
        });

        $('body').on('mouseleave', '.comment', function() {
            $(this).find('.full-comment, .cohort').hide();
        });

        $('.tabs li').on('click', function() {
            var tab = $(this).data('tab');
            $('.tabs .active').removeClass('active');
            $('.active').addClass('hide').removeClass('active');
            $(this).addClass('active');
            $('.'+tab).removeClass('hide').addClass('active');
        });


        // Load data for an NYT url.
        function get_comments(url) {
            $('.subject .error').hide();
            $('.subject .loading').show();
            $.ajax('/api/comments', {
                method: 'GET',
                accepts: 'application/json',
                data: {
                    url: url
                },
                error: function(xhr, status, err) {
                    $('.subject .error').text(err).show();
                },
                success: function(data, status, xhr) {
                    comments = data.comments;
                    $('.subject--title').text(data.title);
                    $('.subject--body').html(data.body);

                    // Load "talked about" and "geigerized" right after
                    get_talked_about();
                    get_geigerized();
                },
                complete: function() {
                    $('.subject .loading').hide();
                }
            });
        }

        // Get Geiger results
        function get_geigerized() {
            var el = $('.geiger'),
                thread = el.find('.thread'),
                terms = el.find('.terms');

            el.find('.loading').show();
            $('.tabs li[data-tab=geiger]')
                .addClass('loading').removeClass('error');
            thread.empty();
            terms.empty();

            $.ajax('/api/geiger', {
                method: 'POST',
                accepts: 'application/json',
                contentType: 'application/json',
                dataType: 'json',
                data: JSON.stringify({
                    comments: comments,
                }),
                error: function(xhr, status, err) {
                    el.find('.error').text(err).show();
                    $('.tabs li[data-tab=geiger]').addClass('error');
                },
                success: function(data, status, xhr) {
                    var data = data.results;

                    for (var i=0; i < data.clusters.length; i++) {
                        var clus = data.clusters[i][0],
                            desc = data.clusters[i][1],
                            clus_html = '',
                            desc_html = '',
                            hel;

                        // List the top 10 terms describing this cluster
                        for (var j=0; j < 10; j++) {
                            desc_html += '<li>' + desc[j][0] + '</li>';
                        }

                        // List out the other comments in this cluster
                        for (var j=0; j < clus.length; j++) {
                            clus_html += '<li>' + clus[j][1] + '</li>';
                        }

                        // Build the HTML.
                        hel = $('#cluster_tmpl')
                                .html()
                                .format(desc_html, clus_html, clus.length);

                        thread.append(hel);
                    }

                    // Render top salient terms
                    for (var i=0; i < 20; i++) {
                        terms.append('<li>'+data.terms[i][0]+'</li>');
                    }
                },
                complete: function() {
                    el.find('.loading').hide();
                    $('.tabs li[data-tab=geiger]').removeClass('loading');
                }
            });
        }

        function get_talked_about() {
            var el = $('.talked-about'),
                thread = el.find('.thread');

            el.find('.loading').show();
            $('.tabs li[data-tab=talked-about]')
                .addClass('loading').removeClass('error');
            thread.empty();

            $.ajax('/api/talked-about', {
                method: 'POST',
                accepts: 'application/json',
                contentType: 'application/json',
                dataType: 'json',
                data: JSON.stringify({
                    comments: comments
                }),
                error: function(xhr, status, err) {
                    el.find('.error').text(err).show();
                    $('.tabs li[data-tab=talked-about]').addClass('error');
                },
                success: function(data, status, xhr) {
                    var data = data.results;
                    for (var i=0; i < data.length; i++) {
                        var res = data[i],
                            coh = '',
                            hel;

                        // List out the other sentences in this cohort.
                        for (var j=0; j < res.cohort.length; j++) {
                            coh += '<li>' + res.cohort[j] + '</li>';
                        }

                        // Build the highlight HTML.
                        hel = $('#highlight_tmpl')
                                .html()
                                .format(res.sentence, res.comment.author, res.support, res.comment.body, coh);

                        thread.append('<h5>{0}</h5>{1}'.format(res.aspect, hel));
                    }
                },
                complete: function() {
                    el.find('.loading').hide();
                    $('.tabs li[data-tab=talked-about]').removeClass('loading');
                }
            });

        }
    });
</script>

{% endblock %}
